var oldPage;var jxl=jxl||(function(){"use strict"
var lib={};var doc=window.document;var head=null;lib.get=function(idOrElement){if(typeof idOrElement=='string'&&idOrElement){return doc.getElementById(idOrElement);}
return idOrElement;};lib.walkDom=function(idOrElement,tag,func){var elem=lib.get(idOrElement);var result=[];if(elem){tag=tag||"*";var noFunc=typeof func!='function';var args=[""];if(!noFunc){for(var i=3,len=arguments.length;i<len;i++){args.push(arguments[i]);}}
var nodes=elem.getElementsByTagName(tag);for(var i=0,len=nodes.length;i<len;i++){args[0]=nodes[i];if(noFunc||func.apply(null,args)){result.push(nodes[i]);}}}
return result;};lib.find=function(selector,parentIdOrElement){var parent=lib.get(parentIdOrElement)||doc;var result;if(parent&&parent.querySelectorAll){result=parent.querySelectorAll(selector);}
return result||[];};var reTrim=/^\s+|\s+$/g;var reWhitespace=/\s+/g;function normalizeClassName(str){str=str.replace(reTrim,"");str=str.replace(reWhitespace," ");return str;}
var classNameCache={};function classNameRegExp(strClass){if(!classNameCache[strClass]){classNameCache[strClass]=new RegExp('(?:^|\\s+)'+strClass+'(?:\\s+|$)');}
return classNameCache[strClass];}
lib.hasClass=function(idOrElement,strClass){var elem=lib.get(idOrElement);if(!elem){return false;}
var re=classNameRegExp(strClass);return re.test(elem.className);};lib.addClass=function(idOrElement,strClasses){var elem=lib.get(idOrElement);if(elem){var theClasses=strClasses.split(/\s+/g);var re;var oldClassName=normalizeClassName(elem.className);var newClassNames;if(!oldClassName){newClassNames=theClasses;}
else{newClassNames=[oldClassName];for(var i=0,len=theClasses.length;i<len;i++){re=classNameRegExp(theClasses[i]);if(!re.test(oldClassName)){newClassNames.push(theClasses[i]);}}}
elem.className=newClassNames.join(' ');}};lib.removeClass=function(idOrElement,strClasses){var elem=lib.get(idOrElement);if(elem&&elem.className){var theClasses=strClasses.split(/\s+/g);var re;var newClassName=elem.className;for(var i=0,len=theClasses.length;i<len;i++){if(theClasses[i]){re=classNameRegExp(theClasses[i]);while(re.test(newClassName)){newClassName=newClassName.replace(re,' ');}}}
elem.className=normalizeClassName(newClassName);}};lib.removeClassRegExp=function(idOrElement,strClasses){var elem=lib.get(idOrElement);if(elem){var newClassName=elem.className;var re=classNameRegExp(strClasses);if(re.test(newClassName)){newClassName=newClassName.replace(new RegExp(strClasses,'ig'),'');}
elem.className=normalizeClassName(newClassName);}};lib.clearClass=function(idOrElement){lib.overwriteClass(idOrElement);};lib.overwriteClass=function(idOrElement,strClasses){var elem=lib.get(idOrElement);if(elem){elem.className=strClasses||"";}};lib.replaceClass=function(idOrElement,strOldClasses,strNewClasses){var elem=lib.get(idOrElement);if(elem){lib.removeClass(elem,strOldClasses);lib.addClass(elem,strNewClasses);}};lib.getByClass=function(strClass,parentIdOrElement,tag){return lib.walkDom(parentIdOrElement||doc,tag||"",function(el){return lib.hasClass(el,strClass);});};var camelCaseCache={};function cssStrToCamelCase(str){var strArr=str.split("-");if(strArr.length<2){return str;}
if(camelCaseCache[str]){return camelCaseCache[str];}
var result=strArr[0];for(var i=1,len=strArr.length;i<len;i++){result+=strArr[i].charAt(0).toUpperCase()+strArr[i].slice(1);}
camelCaseCache[str]=result;return result;}
var reAlpha=/alpha\(opacity=[^\)]+\)/i;function setFilterOpacity(elem,val){if(elem.currentStyle&&!elem.currentStyle.hasLayout){elem.style.zoom=1;}
val=Math.round(val*100);var s=elem.style.filter;var s2='alpha(opacity='+val+')';if(reAlpha.test(s)){elem.style.filter=s.replace(reAlpha,s2);}
else{elem.style.filter+=' '+s2;}}
function setStyleOpacity(elem,val){elem.style.opacity=val;}
function setOpacity(elem,val){if(typeof elem.style.opacity=='string'){setOpacity=setStyleOpacity;elem.style.opacity=val;}
else if(typeof elem.style.filter=='string'){setOpacity=setFilterOpacity;setFilterOpacity(elem,val);}
else{setOpacity=function(){};}}
var strFloat;function setStyleFloat(elem,val){if(!strFloat){strFloat=typeof elem.style.cssFloat=='string'?'cssFloat':'styleFloat';}
elem.style[strFloat]=val;}
lib.setStyle=function(idOrElement,cssName,cssValue){var elem=lib.get(idOrElement);if(elem){switch(cssName){case'opacity':setOpacity(elem,cssValue);break;case'float':setStyleFloat(elem,cssValue);break;default:elem.style[cssStrToCamelCase(cssName)]=cssValue;break;}}};lib.display=function(idOrElement,show){lib.setStyle(idOrElement,"display",show?"":"none");};lib.hide=function(idOrElement){lib.display(idOrElement,false);};lib.show=function(idOrElement){lib.display(idOrElement,true);};lib.loadCss=function(cssPath){if(null==head)head=document.getElementsByTagName("head");if(head&&head[0]&&"string"==typeof cssPath)
{var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=cssPath;head[0].appendChild(link);}};lib.createStyleTag=function(styles){if(null==head)head=document.getElementsByTagName("head");if(head&&head[0]&&"string"==typeof styles)
{var styleTag=document.createElement("style");styleTag.type="text/css";styleTag.innerHTML=styles;head[0].appendChild(styleTag);}};lib.addEventHandler=function(idOrElement,eventName,handlerFunction){var elem=lib.get(idOrElement);if(elem){if(elem.addEventListener){elem.addEventListener(eventName,handlerFunction,false);if(oldPage&&oldPage.registerEventHandler){oldPage.registerEventHandler(idOrElement,eventName,handlerFunction);}
return true;}
else if(elem.attachEvent){elem.attachEvent("on"+eventName,handlerFunction);return true;}
return false;}
return false;};lib.removeEventHandler=function(idOrElement,eventName,handlerFunction){var elem=lib.get(idOrElement);if(elem){if(elem.removeEventListener){elem.removeEventListener(eventName,handlerFunction,false);}
else if(elem.detachEvent){elem.detachEvent("on"+eventName,handlerFunction);}}};lib.evtTarget=function(evt,expectedType){evt=evt||window.event;var result=evt.target||evt.srcElement;if(expectedType){while(result&&result.type!=expectedType){result=result.parentNode;}}
else{if(result&&result.nodeType==3){result=result.parentNode;}}
return result;};lib.stopBubbling=function(evt){evt=evt||window.event;if(evt){if(evt.stopPropagation){evt.stopPropagation();}
evt.cancelBubble=true;}};lib.cancelEvent=function(evt){evt=evt||window.event;if(evt){if(evt.preventDefault){evt.preventDefault();}
evt.cancel=true;evt.returnValue=false;}
return false;};lib.setDisabled=function(idOrElement,disable)
{var elem=lib.get(idOrElement);if(elem){elem.disabled=disable;var p=elem.parentNode;if(p)p=p.parentNode;p=p||doc;if(p){var labels=p.getElementsByTagName('label');for(var i=0,len=labels.length;i<len;i++){if(labels[i].htmlFor==elem.id){if(disable){lib.addClass(labels[i],"disabled");}
else{lib.removeClass(labels[i],"disabled");}
break;}}}}};lib.disableNode=function(idOrNode,disableNode,fogOnly)
{var setNodeOpacity=disableNode?lib.addClass:lib.removeClass;setNodeOpacity(idOrNode,"disableNode");if(fogOnly)return;lib.walkDom(idOrNode,"*",disableNodeSpecials,disableNode);disableNodeSpecials(lib.get(idOrNode),disableNode);};function disableNodeSpecials(node,disableNode)
{if(node)
{switch((node.nodeName||"").toLowerCase())
{case"a":node.onclick=disableNode?function(){return false;}:null;break;case"button":case"input":case"select":node.disabled=disableNode;break;default:break;}}};lib.enableNode=function(idOrNode,disableNode,fogOnly){lib.disableNode(idOrNode,!disableNode,fogOnly);};lib.disable=function(idOrElement){lib.setDisabled(idOrElement,true);};lib.enable=function(idOrElement){lib.setDisabled(idOrElement,false);};lib.getEnabled=function(idOrElement){var elem=lib.get(idOrElement);if(elem){return!elem.disabled;}
return false;};lib.enableWithFocus=function(idOrElement){var elem=lib.get(idOrElement);if(elem){lib.enable(elem);lib.focus(elem);}};lib.addOption=function(idOrElement,value,text){var elem=lib.get(idOrElement);if(elem&&elem.options){elem.options[elem.length||0]=new Option(text,value);}};lib.getOptionTextOf=function(idOrElement,idx){var elem=lib.get(idOrElement);if(elem&&elem.options){return elem.options[idx].text;}
return null;}
lib.lenSelection=function(idOrElement){var elem=lib.get(idOrElement);if(elem&&elem.options){return elem.length;}
return 0;};function findOptionIdx(elem,value){var i=elem.options.length||0;while(i--){if(elem.options[i].value==value){return i;}}
return-1;}
lib.updateOptions=function(idOrElement,value,text){var elem=lib.get(idOrElement);if(elem&&elem.options){var idx=findOptionIdx(elem,value);if(idx<0){idx=elem.options.length||0;elem.options[idx]=new Option(text,value);}
else{elem.options[idx].text=text;}}};lib.deleteOption=function(idOrElement,value){var elem=lib.get(idOrElement);if(elem&&elem.options){var idx=findOptionIdx(elem,value);if(idx>=0){elem.options[idx]=null;if(value==elem.value){elem.selectedIndex=0;}}}};lib.clearSelection=function(idOrElement){var elem=lib.get(idOrElement);if(elem){var disabled=elem.disabled;elem.disabled=false;elem.length=0;elem.disabled=disabled;}};lib.setSelection=function(idOrElement,text){var elem=lib.get(idOrElement);if(elem==null){return;}
var disabled=elem.disabled;elem.disabled=false;var i=0;var n=-1;for(i=0;i<elem.length;i++){if(elem.options[i].value==text){n=i;break;}}
if(n!=-1){for(i=0;i<elem.length;i++){elem.options[i].selected=(n==i);}}
elem.disabled=disabled;};lib.submitForm=function(name){var frm=doc.forms[name||0];if(frm){if(oldPage&&oldPage.takeoverSubmit(frm)){return false;}else{frm.submit();}}};lib.getFormElements=function(elementName,formNameOrIdx){var result=[];if(elementName){var f=doc.forms[formNameOrIdx||0];if(f&&f.elements){var elems=f.elements[elementName];if(elems){result=[elems];if(typeof elems.length=='number'){if(!elems.options||elems[0]!=elems.options[0]){result=elems;}}}}}
return result;};lib.getForm=function(idOrElement){var elem=lib.get(idOrElement);if(elem){if(elem.form){return lib.get(elem.form);}
return lib.findParentByTagName(elem,"form");}
return null;};lib.getByName=function(name,parentIdOrElement){var elem=doc;if(parentIdOrElement){elem=lib.get(parentIdOrElement);}
if(elem&&typeof name=='string'){return elem.getElementsByName(name);}
return null;};lib.getHtml=function(idOrElement){var elem=lib.get(idOrElement);if(elem){return elem.innerHTML;}
return"";};lib.setHtml=function(idOrElement,txt){var elem=lib.get(idOrElement);if(elem){elem.innerHTML=txt;}};lib.changeImage=function(imageName,newSource,newTitle){var image=document.images[imageName]||lib.get(imageName);if(image){if(typeof newSource!='undefined'){image.src=newSource;}
if(typeof newTitle!='undefined'){image.title=newTitle;}}};lib.setText=function(idOrElement,txt){var elem=lib.get(idOrElement);if(elem){if(elem.hasChildNodes()){elem.innerHTML="";}
elem.appendChild(document.createTextNode(txt));}};lib.getText=function(idOrElement)
{var elem=lib.get(idOrElement);if(elem){return elem.innerHTML}
return"";}
lib.focus=function(idOrElement,value){var elem=lib.get(idOrElement);if(elem&&typeof elem.focus!='undefined'){elem.focus();}};lib.select=function(idOrElement,value){var elem=lib.get(idOrElement);if(elem&&typeof elem.select!='undefined'){elem.select();}};lib.getChecked=function(idOrElement){var elem=lib.get(idOrElement);if(elem){return elem.checked;}
return false;};lib.setChecked=function(idOrElement,value){var elem=lib.get(idOrElement);if(elem){elem.checked=(value!==false);}};lib.getValue=function(idOrElement){var elem=lib.get(idOrElement);if(elem){return elem.value;}
return"";};lib.getSelectValue=lib.getValue;lib.setValue=function(idOrElement,value){var elem=lib.get(idOrElement);if(elem){elem.value=value;}};lib.getRadioValue=function(radioName,formNameOrIdx){var radios=lib.getFormElements(radioName,formNameOrIdx);var i=radios.length||0;while(i--){if(radios[i].checked){return radios[i].value;}}
return"";};lib.getCssText=function(elem){if(!elem||!elem.style){return"";}
if(typeof elem.style.cssText=='string'){return elem.style.cssText;}
else{return elem.getAttribute('style');}}
lib.setCssText=function(elem,cssText){if(!elem||!elem.style){return;}
if(typeof elem.style.cssText=='string'){elem.style.cssText=cssText;}
else{elem.setAttribute('style',cssText);}}
function changeInputTypeIE(el,newType){var el2=doc.createElement('input');el2.type=newType;el2.name=el.name;el2.value=el.value;el2.id=el.id;el2.className=el.className;var cssText=lib.getCssText(el);lib.setCssText(el2,cssText);el.parentNode.replaceChild(el2,el);}
var changeInputType=(function(){try{var tst=doc.createElement('input');tst.type="password";tst.type="hidden";}
catch(err){return changeInputTypeIE;}
return function(el,newType){el.type=newType;};})();lib.changeInputType=function(idOrElement,newType){var elem=lib.get(idOrElement);if(elem&&typeof newType=='string'){changeInputType(elem,newType);}};lib.moveElement=function(idOrElement,hookIdOrElement){var elem=lib.get(idOrElement);var hook=lib.get(hookIdOrElement);if(elem&&hook&&hook.parentNode){hook.parentNode.insertBefore(elem,hook);}};lib.findParentByTagName=function(idOrElement,tagName){tagName=(tagName||"").toLowerCase();var elem=lib.get(idOrElement);while(elem&&elem.parentNode){elem=elem.parentNode;if((elem.tagName||"").toLowerCase()==tagName){return elem;}}
return null;};lib.setHiddenValue=function(name,value,formIdOrElement){var form=lib.get(formIdOrElement)||doc.forms[0];if(form){var inp=form.elements[name];var isNew=!inp;if(isNew){inp=document.createElement("input");inp.setAttribute("type","hidden");inp.name=name;}
inp.value=value;if(isNew){form.appendChild(inp);}}};lib.removeElements=function(idsOrElements){var i=(idsOrElements||[]).length||0;while(i--){var elem=lib.get(idsOrElements[i]);if(elem&&elem.parentNode){elem.parentNode.removeChild(elem);}}};lib.sprintf=function(formatstr){var i,exp;for(i=1;i<arguments.length;++i)
{exp=new RegExp("(%"+i+")(%[a-zA-Z]+%)?","g");formatstr=formatstr.replace(exp,"$1");exp=new RegExp("%"+i,"g");formatstr=formatstr.replace(exp,arguments[i]);}
return formatstr;};lib.toArray=function(arrayLike){var array=[];var i=arrayLike.length;while(i--){array[i]=arrayLike[i];}
return array;};lib.getArrayPart=function(luaTable,doDelete){luaTable=luaTable||{};var array=[];var n=1;while(typeof luaTable[n]!='undefined'){array.push(luaTable[n]);if(doDelete){delete luaTable[n];}
n++;}
return array;};var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':'&quot;'};lib.htmlEscape=function(str){return String(str).replace(/[&<>"]/g,function(s){return entityMap[s];});};lib.htmlUnEscape=function(str){for(var i in entityMap){str=String(str).replace(new RegExp(entityMap[i],"g"),i);}
str=String(str).replace(new RegExp("&apos;","g"),"'");return str;};lib.getParams=function(obj){var params=""
for(var i in obj){if(params!="")
params+="&";params+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i]);}
return params;};lib.toFixed=function(num,decimals,decimalPoint){var n=Number(num);if(isNaN(n)){return num;}
n=n.toFixed(Number(decimals)||0);if(decimalPoint){n=n.replace(".",decimalPoint);}
return n;};lib.mergeObjects=function(defaultObj,updateObj){defaultObj=defaultObj||{};updateObj=updateObj||{};var result={};for(var name in defaultObj){if(defaultObj.hasOwnProperty(name)){result[name]=defaultObj[name];}}
for(var name in updateObj){if(updateObj.hasOwnProperty(name)){result[name]=updateObj[name];}}
return result;};lib.setTimeout=function(fn,delay){if(oldPage){return oldPage.setAndRegisterTimeout(fn,delay);}else{return setTimeout(fn,delay);}};lib.goTo=function(url){if(oldPage){oldPage.submitLink(url);}else{location.href=url;}};return lib;})();var avmLog=function(){};if(config.isDebug>0){avmLog=(function(){var prefix="AVMLOG: ";var c=(top||window).console;return function(){c=c||(top||window).console;if(c){var args=[prefix].concat(jxl.toArray(arguments));if(typeof c.log=='function'){c.log.apply(c,args);}
else{c.log(args);}}};})();}
var oldPage;function ajaxAllowed(){return!oldPage||!oldPage.jsLocked();}
function ajaxGet(url,callback,abortAfter){return sendXhr("GET",url,null,callback,{abortAfter:abortAfter});}
function ajaxPost(url,postData,callback){return sendXhr("POST",url,postData,callback,{});}
function ajaxPostSync(url,postData){return sendXhr("POST",url,postData,null,{aSync:false});}
function ajaxUpdateHtml(uiId,page,sid,timeout,addCallback){timeout=Number(timeout)||0;var url=encodeURI(page);url=addUrlParam(url,"update",uiId);if(sid){url=addUrlParam(url,"sid",sid);}
function request(){ajaxGet(url,callback);}
function callback(xhr){if(xhr&&xhr.status==200){jxl.setHtml(uiId,xhr.responseText);if(addCallback){var newTimeout=addCallback(uiId,xhr);if(typeof newTimeout=='number'){timeout=newTimeout;}}
zebra();}
if(timeout>0){jxl.setTimeout(request,timeout);}}
jxl.setTimeout(request,timeout||0);}
function ajaxWait(vars,sid,poll,cb){var stop=false;var query="/query.lua?sid="+sid;var json=makeJSONParser();for(var name in vars){query=query+"&"+name+"="+vars[name].query;}
function request(){return ajaxGet(query,cbResponse);}
function cbResponse(xhr){var resp=json(xhr.responseText||"null");if(resp){for(var name in vars){vars[name]["value"]=resp[name]||"";}}
if(!cb(resp?vars:null)){jxl.setTimeout(request,poll);}}
return request();}
function ajaxWaitForBox(cbCustom,abort){var url=encodeURI("/");var timer;var count_retries=0;var boxStillOnline=true;var requestTimeout=5000;var finished;function goToBox(){top.location.href="/";}
if(cbCustom&&typeof cbCustom=="function"){finished=cbCustom;}else{finished=goToBox;}
function callback(response){if(response&&response.status==200){if(boxStillOnline){count_retries++;if(abort&&count_retries>abort)
{jxl.setTimeout(finished,5000);}
timer=jxl.setTimeout(doRequest,requestTimeout);}
else{jxl.setTimeout(finished,30000);}}
else{boxStillOnline=false;timer=jxl.setTimeout(doRequest,requestTimeout);}}
function doRequest(){sendXhr("GET",url,null,callback);}
jxl.setTimeout(doRequest,requestTimeout);}
function sendXhr(method,url,postData,callback,options){var allowed=true;options=options||{};var abortAfter=options.abortAfter;var aSync=(options.aSync!==false);var abortTimeout;var xhr=newXhr();if(!xhr){return false;}
method=method.toUpperCase();if(method=="GET"){url=addUrlParam(url,"xhr","1");url=addUrlParam(url,"t"+String((new Date()).getTime()),"nocache");}
xhr.open(method,url,aSync);if(method=="POST"){postData=[postData||"","xhr=1"].join("&");xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}
xhr.onreadystatechange=function(){if(xhr.readyState==4){allowed=ajaxAllowed();if(!allowed){callback=null;}
clearTimeout(abortTimeout);if(checkLoggedin(xhr)){if(typeof callback=='function'){callback(xhr);callback=null;}}
xhr.onreadystatechange=function(){};}};if(abortAfter){abortTimeout=jxl.setTimeout(function(){stopXhr(xhr);if(typeof callback=='function'){callback("aborted");callback=null;}},abortAfter);}
allowed=ajaxAllowed();if(allowed){xhr.send(postData);}
if(typeof oldPage!='undefined'){oldPage.registerXhr(xhr);}
return xhr;}
function stopXhr(xhr){if(xhr&&xhr.readyState&&xhr.readyState<4){xhr.onreadystatechange=function(){};xhr.abort();}}
function newXhr(){var createFuncs=[function(){return new XMLHttpRequest();},function(){return new ActiveXObject("Msxml2.XMLHTTP");},function(){return new ActiveXObject("Microsoft.XMLHTTP");}];var xhr=null;for(var i=0;i<createFuncs.length;i++){try{xhr=createFuncs[i]();if(xhr){newXhr=createFuncs[i];return xhr;}}
catch(err){}}
newXhr=function(){return null;};return null;}
function makeJSONParser(){if(window.JSON&&typeof window.JSON.parse=='function'){return window.JSON.parse;}
else{return function(txt){return(new Function('return ('+txt+')'))();};}}
function buildUrlParam(name,value){if(typeof value=='undefined'){value="";}
return encodeURIComponent(name)+"="+encodeURIComponent(value);}
function addUrlParam(url,name,value){if(!name){return url;}
var sep="&";url=url||"";if(url.indexOf("?")<0){sep="?";}
return url+sep+buildUrlParam(name,value);}
function addUrlParamTable(params){var result=[];for(var name in params){if(params.hasOwnProperty(name)){result.push(buildUrlParam(name,params[name]));}}
return result.join("&");}
function stripSid(url){url=url||"";url=url.replace(/sid=[a-fA-F0-9]+/g,"")
url=url.replace(/\?&/,"?");url=url.replace(/&&/g,"&");url=url.replace(/&$/,"");url=url.replace(/\?$/,"");return url;}
function checkLoggedin(xhr){if(xhr.status==403){var url=(location.href||"").split("#");url[0]=stripSid(url[0]);if(typeof gAppAutoLogoutHint!='undefined'&&gAppAutoLogoutHint===true){url[0]=addUrlParam(url[0],"logout","2");}
jxl.goTo(url.join("#"));return false;}
return true;}
function postEncode(str){var result=encodeURIComponent(str);result=result.replace(/%20/g,'+');result=result.replace(/(.{0,3})(%0A)/g,function(m,s1,s2){return s1+(s1=='%0D'?'':'%0D')+s2;});result=result.replace(/(%0D)(.{0,3})/g,function(m,s1,s2){return s1+(s2=='%0A'?'':'%0A')+s2;});return result;}
function ajaxRequest(options){var cfg={};cfg.method=(options.method||"GET").toUpperCase();cfg.url=options.url||"";cfg.sync=(cfg.method=="POST"&&Boolean(options.sync));cfg.params=options.params||{};cfg.type=(options.type||'json').toLowerCase();cfg.callback=options.callback||function(){};if(options.sidRenew!==true){cfg.params.no_sidrenew="";}
var xhr;var json=makeJSONParser();function buildParams(params){params=params||{};var encFunc=encodeURIComponent;if(cfg.method=="POST"){encFunc=postEncode;}
var data=[];for(var name in params){if(name&&params.hasOwnProperty(name)){var value=params[name];if(typeof value=='undefined'){value="";}
data.push(encFunc(name)+"="+encFunc(value));}}
return data.join("&");}
function callback(xhr){var answer;switch(cfg.type){case'html':{answer=xhr.responseText||"";break;}
case'json':default:{answer=json(xhr.responseText||"null");answer=answer||{answer:false};break;}}
cfg.callback(answer);}
function start(addParams){var url=cfg.url;var params=jxl.mergeObjects(cfg.params,addParams);var data=buildParams(params);if(cfg.method=="GET"){url+="?"+data;data=null;}
if(cfg.sync){xhr=sendXhr(cfg.method,url,data,null,{aSync:false});callback(xhr);}
else{xhr=sendXhr(cfg.method,url,data,callback);}}
function stop(){stopXhr(xhr);}
return{start:start,stop:stop};}
var oldPage;function ajaxValidation(options){options=options||{};var url=options.url;var formNameOrIndex=options.formNameOrIndex||0;var applyNames=(options.applyNames||"apply").split(/\s*,\s*/g);var okCallback=options.okCallback;var aSync=options.aSync;var showWait=options.showWait;var openPopup=options.openPopup;var form,clicked,json;var directCall=options.directCall;if(directCall||oldPage){aSync=false;}
function init(){form=document.forms[formNameOrIndex||0];if(!form){return;}
url=url||form.getAttribute("action");if(oldPage){form.onsubmit=oldPage.submitFunc(doDirectOldpageCall,applyNames);}else{if(!directCall){var n=applyNames.length;while(n--){var applyElements=jxl.getFormElements(applyNames[n],formNameOrIndex);var i=applyElements.length;while(i--){jxl.addEventHandler(applyElements[i],"click",onClickApply);}}
jxl.addEventHandler(form,"submit",aSync?onSubmit:onSubmitSync);}}
json=makeJSONParser();}
function postEncode(str,multiline){var result=encodeURIComponent(str);result=result.replace(/%20/g,'+');if(multiline){result=result.replace(/(.{0,3})(%0A)/g,function(m,s1,s2){return s1+(s1=='%0D'?'':'%0D')+s2;});result=result.replace(/(%0D)(.{0,3})/g,function(m,s1,s2){return s1+(s2=='%0A'?'':'%0A')+s2;});}
return result;}
function readValue(el){switch(el.type||""){case'submit':break;case'file':break;case'checkbox':if(el.checked){return el.value||"on";}
break;case'radio':if(el.checked){return el.value||"";}
break;default:return el.value||"";break;}
return null;}
function serializeForm(validate){var elems=form&&form.elements||[];var result=[];var el,name,value;for(var i=0,len=elems.length;i<len;i++){el=elems[i];name=el.name;if(name&&!el.disabled){value=readValue(el);if(value!==null){result.push(postEncode(name)+"="+postEncode(value,el.type=='textarea'));}}}
if(validate){result.push(postEncode("validate")+"="+postEncode(validate));}
return result.join('&');}
function showValidationWait(doShow){if(showWait){var wait=jxl.get("uiValidationWait");if(wait){jxl.display(form,!doShow);jxl.display(wait,doShow);}}}
function onClickApply(evt){var btn=jxl.evtTarget(evt);if(btn){clicked=btn.name;showValidationWait(true);}}
function removeAllErrors(){var elems=form&&form.elements||[];var i=elems.length;while(i--){jxl.removeClass(elems[i],"error");}}
function onSubmitSync(evt){if(clicked){removeAllErrors();var data=serializeForm(clicked);var xhr=ajaxPostSync(url,data);var ok=validationCallback(xhr);if(!ok){return jxl.cancelEvent(evt);}}}
function onSubmit(evt){if(clicked){removeAllErrors();var data=serializeForm(clicked);ajaxPost(url,data,validationCallback);return jxl.cancelEvent(evt);}}
function addApplyElement(name){var applyElem=document.createElement("input");applyElem.setAttribute("type","hidden");applyElem.name=name;form.appendChild(applyElem);}
function onFocus(evt){var elem=jxl.evtTarget(evt);jxl.removeClass(elem,"error");jxl.removeEventHandler(elem,"focus",onFocus);}
function onFocusIdx(evt){var elem=jxl.evtTarget(evt);var name=elem.name.replace(/\d$/,"");var el,idx=0;while(el=form.elements[name+idx]){jxl.removeClass(el,"error");jxl.removeEventHandler(el,"focus",onFocusIdx);idx++;}}
function setError(name){if(name){var els=jxl.getFormElements(name,formNameOrIndex);var i=els.length;if(i==0){var el,idx=0;while(el=form.elements[name+idx]){jxl.addClass(el,"error");jxl.addEventHandler(el,"focus",onFocusIdx);idx++;}}
else if(i==1){jxl.addClass(els[0],"error");jxl.addEventHandler(els[0],"focus",onFocus);}
else if(i>1){while(i--){if(els[i].checked){jxl.addClass(els[i],"error");jxl.addEventHandler(els[i],"focus",onFocus);}}}}}
function createPopup(answer){if(answer.popup&&answer.popup.url){return function(){var ppUrl=answer.popup.url;var opts=answer.popup.opts||"width=450,height=400,resizable=yes,scrollbars=yes,location=no";var ppWindow=window.open(ppUrl,"Zweitfenster",opts);if(ppWindow){ppWindow.focus();}};}}
function doPopupAfterClick(popup,validate){jxl.addEventHandler("uiValidationDoneOk","click",function(evt){popup();jxl.disable("uiValidationDoneOk");addApplyElement(validate);jxl.submitForm(formNameOrIndex);});jxl.hide(form);jxl.hide("uiValidationWait");jxl.show("uiValidationDone");}
function validationCallback(xhr){var answer=json(xhr.responseText||"{}");if(answer.ok){var confirmed=true;if(answer.confirm){var i=0,len=answer.confirm.length;while(i<len&&confirmed){confirmed=confirm(answer.confirm[i]);i++;}}
if(confirmed&&okCallback){confirmed=okCallback();}
if(confirmed!==false){var popup=createPopup(answer)||openPopup;if(aSync){if(popup){doPopupAfterClick(popup,answer.validate);}
else{addApplyElement(answer.validate);jxl.submitForm(formNameOrIndex);}}
else{if(popup){popup();}}
return true;}
showValidationWait(false);}
else{showValidationWait(false);var toMark=answer.tomark||[];if(typeof toMark=='string'){toMark=[toMark];}
var i=toMark.length;while(i--){setError(toMark[i]);}
if(answer.alert){alert(answer.alert);}}
clicked=null;return false;}
function doDirectCall(validate){clicked=validate||"apply";return onSubmitSync()!==false;}
function doDirectOldpageCall(evt,validate){clicked=validate||"apply";return onSubmitSync(evt)!==false;}
if(directCall){init();return doDirectCall;}
else{return init;}}
var zebra=(function(){function testZebra(){var result=true;var css=document.styleSheets;if(css&&css.length){css=css[0];if(css.addRule){try{css.addRule("div.zebratest div:nth-child(odd)","color:red");css.removeRule(css.rules.length-1);}
catch(err){result=false;}}}
return result;}
function isZebra(tbl){return jxl.hasClass(tbl,"zebra")||jxl.hasClass(tbl,"zebra_reverse");}
function doZebra(){var tables=jxl.walkDom(document,"table",isZebra);var n=tables.length;for(var i=0;i<n;i++){var trs=tables[i].rows;var even=true;for(var j=0;j<trs.length;j++){even=!even;jxl.removeClass(trs[j],even?"zebraOdd":"zebraEven");jxl.addClass(trs[j],even?"zebraEven":"zebraOdd");}}}
if(!testZebra()){return doZebra;}
else{return function(){};}})();
var help=(function(){var helpWin=null;function popup(href){var opts="width=800,height=600,resizable=yes,scrollbars=yes,toolbar=yes,location=yes";if(!helpWin||typeof(helpWin.closed)=='undefined'||helpWin.closed){helpWin=window.open(href,"HelpWindow",opts);}
else{helpWin.location.href=href;}
if(helpWin){helpWin.focus();}}
function show(){jxl.walkDom(document,"",function(elem){if(jxl.hasClass(elem,"hidden_help")){elem.style.display="";}});}
function onClickBoxlink(evt){evt=evt||window.evt;var elem=evt.target||evt.srcElement;window.opener.location.href=elem.href;jxl.cancelEvent(evt);window.close();return false;}
function convertBoxlinks(){jxl.walkDom(document,"a",function(a){if(jxl.hasClass(a,"boxlink")){jxl.addEventHandler(a,'click',onClickBoxlink);}});}
return{popup:popup,show:show,convertBoxlinks:convertBoxlinks};})();
